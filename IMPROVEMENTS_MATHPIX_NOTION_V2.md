# Mathpix 및 Notion 업무 개선사항 (최신 업데이트)

> **업데이트 날짜**: P3, P4 작업 완료 후  
> **이전 버전**: `IMPROVEMENTS_MATHPIX_NOTION.md`

## 최근 작업에서 발견된 새로운 문제점

### 1. 문제 번호 추출 및 매칭 문제 (P4 작업 중 발견)
- **문제**: 비순차적 문제 번호 처리
  - P4에서 문제 번호가 `(13)`, `(11)` 같은 비순차적 번호
  - 섹션 헤더에서 추출은 되지만, JSON의 `index` 필드와 Notion의 문제ID 매칭이 어려움
  - 예: `P4_13` -> JSON에서 `index: "13"` 찾기, `P4_11` -> JSON에서 `index: "11"` 찾기
- **현재 상태**: 기본적인 매칭은 되지만, 더 정확한 매칭 필요
- **영향**: 잘못된 문제-해설 매칭 가능성

### 2. 원본 LaTeX 수식 오류 (P4 해설 작업 중 발견)
- **문제**: Mathpix 변환 시 잘못된 LaTeX 수식 생성
  - 잘못된 형태: `\left.\left|k \vec{a}+|\vec{b}|^{2}=k^{2}\right| \vec{a}\right|^{2}+l^{2}|\vec{b}|^{2}+2 k l(\vec{a} \cdot \vec{b})`
  - 올바른 형태: `|k \vec{a}+l \vec{b}|^{2}=k^{2}|\vec{a}|^{2}+l^{2}|\vec{b}|^{2}+2 k l(\vec{a} \cdot \vec{b})`
- **원인**: Mathpix가 복잡한 수식을 잘못 인식
- **영향**: Deepseek이 잘못된 수식을 읽게 되어 학습에 오류 발생 가능
- **현재 상태**: 변환 시 그대로 반영됨 (수정 로직 없음)

### 3. 핵심개념 검증 과도한 경고 (P3, P4 작업 중 발견)
- **문제**: 핵심개념이 해설에 명시적으로 언급되지 않는다는 경고가 과도하게 발생
  - 예시 경고들:
    - "타원의장단축과이심률"이 해설에 명시적으로 다뤄지지 않음
    - "공간직선의매개변수방정식"이 해설에 명시적으로 다뤄지지 않음
    - "직선과원의벡터방정식"이 해설에 명시적으로 다뤄지지 않음
  - 실제로는 해설이 일반적인 Drill 형식이라 특정 개념을 명시하지 않을 수 있음
- **영향**: 실제 문제가 아닌데도 경고가 많이 발생하여 중요한 경고를 놓칠 수 있음
- **현재 상태**: 경고는 발생하지만 실제 오류는 아님

### 4. 벡터 문제 특화 처리 부족 (P4 작업 중 발견)
- **문제**: 벡터 문제에 대한 특화된 검증 및 생성 로직이 추가되었지만, 더 세밀한 개선 필요
  - 벡터의 일차결합, 내적, 크기 제곱 등 다양한 패턴 처리
  - 원과 벡터를 결합하는 문제 처리
  - 정사영과 내적 관련 검증
- **현재 상태**: 기본적인 벡터 처리 로직은 있지만, 더 정교한 패턴 인식 필요

### 5. 선택지 추출 시 섹션 헤더 포함 문제 (P3, P4 작업 중 발견)
- **문제**: 선택지 추출 시 다음 문제의 섹션 헤더가 포함될 수 있음
  - 예: 문제 22번의 선택지에 문제 23번의 섹션 헤더가 포함됨
- **현재 상태**: 섹션 헤더 제거 로직이 있지만, 완벽하지 않음
- **영향**: 잘못된 선택지 추출

## 개선 방안

### 1. 문제 번호 추출 및 매칭 개선
- **방안 1**: 섹션 헤더의 다양한 형식 지원 강화
  ```python
  # 현재: (13), (11) 형식만 지원
  # 개선: 다양한 형식 지원
  - (13), (11) 형식: 괄호 안 숫자 추출
  - 13, 11 형식: 숫자만 추출
  - Chapter 2 형식: 무시
  ```

- **방안 2**: 문제ID와 JSON index 매칭 로직 개선
  ```javascript
  // 현재: P4_13 -> 13 추출 후 problemMap['13'] 찾기
  // 개선: 더 정확한 매칭
  - 문제ID에서 숫자 추출: P4_13 -> 13
  - JSON에서 index 필드와 매칭: index: "13"
  - 매칭 실패 시 순차적 매칭 시도
  ```

- **방안 3**: 문제 번호가 비순차적일 때도 정확히 매칭
  - 섹션 헤더의 문제 번호를 우선 사용
  - 문제ID의 번호를 보조로 사용

### 2. LaTeX 수식 오류 자동 감지 및 수정
- **방안 1**: 잘못된 LaTeX 수식 패턴 감지
  ```python
  # 잘못된 패턴 감지
  - \left.\left|... 패턴 감지
  - 벡터 크기 제곱 공식 오류 감지
  - 수식 구조 분석 (괄호 매칭 등)
  ```

- **방안 2**: 자동 수정 로직 추가
  ```python
  # 수정 예시
  잘못된: \left.\left|k \vec{a}+|\vec{b}|^{2}=k^{2}\right| \vec{a}\right|^{2}
  올바른: |k \vec{a}+l \vec{b}|^{2}=k^{2}|\vec{a}|^{2}
  ```

- **방안 3**: 수정 전후 비교 로그 출력
  - 수정된 수식과 원본 수식 비교
  - 수정 사항 로그 저장

### 3. 핵심개념 검증 완화
- **방안 1**: 관련 키워드 기반 검증
  ```javascript
  // 현재: 정확한 문자열 매칭만
  // 개선: 관련 키워드 기반 검증
  - "타원의장단축과이심률" -> "타원", "장축", "단축", "이심률" 키워드 검색
  - 하나라도 있으면 통과
  ```

- **방안 2**: 문제 유형별 필터링 강화
  ```javascript
  // 벡터 문제: 벡터 관련 개념만 검증
  // 이차곡선 문제: 이차곡선 관련 개념만 검증
  // 관련 없는 개념은 검증 제외
  ```

- **방안 3**: 해설 형식 고려
  - Drill 형식 해설은 일반적인 내용이므로 완화된 검증 적용
  - 문제별 구체적 해법이 있는 경우에만 엄격한 검증

### 4. 벡터 문제 특화 처리 강화
- **방안 1**: 벡터 패턴별 세밀한 검증
  ```javascript
  // 벡터의 일차결합 패턴
  - k\vec{a}+l\vec{b} 형태 감지
  - 벡터방정식 패턴 감지
  - 벡터의 크기 제곱 패턴 감지
  ```

- **방안 2**: 원과 벡터 결합 문제 특화
  - 원의 방정식과 벡터 연산 결합 패턴 인식
  - 원의 중심, 반지름과 벡터 관계 검증

- **방안 3**: 정사영과 내적 관련 검증 추가
  - 정사영을 이용한 내적 계산 패턴 인식
  - 정사영과 내적의 관계 검증

### 5. 선택지 추출 개선
- **방안 1**: 섹션 헤더 제거 로직 강화
  ```python
  # 선택지 추출 시
  - 섹션 헤더 패턴 감지: \section*\{...\}
  - 섹션 헤더 이전까지만 추출
  - 다음 문제의 섹션 헤더가 포함되지 않도록 제한
  ```

- **방안 2**: 선택지 길이 제한
  - 선택지가 너무 길면 다음 문제 내용일 수 있음
  - 적절한 길이 제한 (현재 200자)

### 6. 해설 변환 시 수식 정확성 검증
- **방안**: 변환된 마크다운의 수식 정확성 검증
  ```python
  # 수식 검증 로직
  - 벡터 크기 제곱 공식 검증
  - 수식 구조 검증 (괄호 매칭 등)
  - 잘못된 수식 감지 시 경고 출력
  ```

## 구현 우선순위

### 높음 (즉시 개선 필요)
1. ✅ 문제 번호 추출 및 매칭 개선 (P4 작업 중 부분 개선됨)
2. ⚠️ LaTeX 수식 오류 자동 감지 및 수정 (감지만 되고 수정 로직 없음)
3. ⚠️ 핵심개념 검증 완화 (과도한 경고 발생)

### 중간 (다음 작업 전 개선 권장)
4. 벡터 문제 특화 처리 강화
5. 선택지 추출 개선

### 낮음 (점진적 개선)
6. 해설 변환 시 수식 정확성 검증

## 적용된 개선사항

### P3, P4 작업에서 이미 적용된 개선사항
1. ✅ 벡터 문제 유형 판별 및 특화 처리 추가
2. ✅ 벡터 문제에 대한 원리공유문제/오답시나리오 생성 로직 추가
3. ✅ 문제 유형별 검증 로직 분리 (벡터, 타원, 쌍곡선, 포물선)
4. ✅ 선택지 추출 시 섹션 헤더 제거 로직 추가
5. ✅ 문제 번호 추출 로직 개선 (섹션 헤더의 `(13)`, `(11)` 형식 지원)

## 다음 작업 시 적용할 개선사항

### 1. LaTeX 수식 오류 자동 수정
```python
def fix_latex_math_errors(latex_content):
    """잘못된 LaTeX 수식 자동 수정"""
    # 잘못된 패턴: \left.\left|k \vec{a}+|\vec{b}|^{2}=k^{2}\right|
    # 올바른 패턴: |k \vec{a}+l \vec{b}|^{2}=k^{2}|\vec{a}|^{2}
    
    # 패턴 감지 및 수정
    pattern = r'\\left\\.\\left\\|([^|]+)\\+\\|([^|]+)\\|\\^{2}=([^|]+)\\right\\|'
    # 수정 로직 구현
```

### 2. 핵심개념 검증 완화
```javascript
// 관련 키워드 기반 검증
function validateConceptWithKeywords(concept, solution) {
    const keywords = extractKeywords(concept);
    // 예: "타원의장단축과이심률" -> ["타원", "장축", "단축", "이심률"]
    return keywords.some(keyword => solution.includes(keyword));
}
```

### 3. 문제 번호 매칭 개선
```javascript
// 더 정확한 매칭 로직
function matchProblemIndex(문제ID, problemMap) {
    // 1. 문제ID에서 숫자 추출: P4_13 -> 13
    // 2. JSON에서 index 필드와 매칭
    // 3. 매칭 실패 시 순차적 매칭 시도
    // 4. 섹션 헤더의 문제 번호 우선 사용
}
```

## 참고사항

- P3, P4 작업에서 벡터 문제 처리 로직이 추가되었지만, 더 세밀한 개선 필요
- 원본 LaTeX 수식 오류는 Mathpix 변환 단계에서 발생하므로, 변환 후 자동 수정 로직 필요
- 핵심개념 검증은 완화하되, 실제 중요한 오류는 놓치지 않도록 균형 필요
